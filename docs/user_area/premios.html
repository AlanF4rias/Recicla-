<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../output.css">
    <style>
        html {
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji';
        }
    </style>
    <title>Prêmios</title>
</head>

<body class="font-sans bg-gray-50 text-gray-800">
    <header>
        <nav class="flex flex-col md:flex-row md:justify-between items-center text-black bg-emerald-200 py-3 px-5">
            <img class="max-w-25" src="/public/logo.png" alt="Logo">
            <div class="flex gap-3 items-center">
                <ul class="flex gap-8 md:gap-15 text-lg font-medium">
                    <li><a href="home.html" class="hover:text-gray-700">Home</a></li>
                    <li><a href="mapa.html" class="hover:text-gray-700">Mapa</a></li>
                    <li><a href="premios.html" class="font-bold text-emerald-700">Prêmios</a></li>
                </ul>
            </div>
            <div class="flex flex-row gap-4 items-baseline mr-5">
            </div>
        </nav>
    </header>
    <main class="min-h-screen bg-gray-50 pb-10">
        <section class="bg-emerald-50 py-10 mb-8 shadow-md">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <h1 class="text-4xl font-extrabold text-emerald-700 text-center mb-6">Seu Mundo de Recompensas
                    Sustentáveis</h1>
                <div class="flex justify-between items-center w-full max-w-lg mx-auto h-[2%] rounded-[1.25rem] bg-white my-4 p-5 shadow-xl border border-emerald-200">
                    <div class="flex flex-col">
                        <p class="text-xl font-medium text-gray-600">Seu Saldo Atual</p>
                        <p class="text-[2.5rem] font-bold text-amber-500" id="pontos-usuario"></p>
                    </div>
                    <i class="bi bi-recycle text-5xl text-emerald-700"></i>
                </div>
                <nav class="flex justify-center flex-wrap gap-3 mt-6">
                    <button
                        class="px-5 py-2 text-white bg-emerald-700 rounded-full text-sm font-semibold shadow-md transition duration-300 hover:bg-emerald-800 active">Todos</button>
                    <button
                        class="px-5 py-2 text-emerald-700 border border-emerald-700 bg-white rounded-full text-sm font-semibold transition duration-300 hover:bg-emerald-700 hover:text-white">Eco-Produtos</button>
                    <button
                        class="px-5 py-2 text-emerald-700 border border-emerald-700 bg-white rounded-full text-sm font-semibold transition duration-300 hover:bg-emerald-700 hover:text-white">Serviços</button>
                    <button
                        class="px-5 py-2 text-emerald-700 border border-emerald-700 bg-white rounded-full text-sm font-semibold transition duration-300 hover:bg-emerald-700 hover:text-white">Doações</button>
                </nav>
            </div>
        </section>
        <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Catálogo de Resgate</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="CardProduto bg-white rounded-xl shadow-lg overflow-hidden transition duration-300 transform hover:scale-[1.02] border border-gray-100" data-produto-id="1" data-produto-preco="50">
                    <div class="h-40 bg-cover bg-center"
                        style="background-image: url('https://picsum.photos/400/200?random=1');">
                    </div>
                    <div class="p-5 text-center">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Caneta</h3>
                        <p class="text-gray-600 text-sm mb-4">Caneta tinteiro feita de materiais reciclados</p>
                        <div class="text-2xl font-extrabold text-amber-500 mb-4">
                            <i class="fas fa-leaf text-emerald-700 mr-2"></i> 50 Pontos
                        </div>
                        <button
                            class="button-resgate w-full py-2 bg-emerald-700 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-800 transition duration-300 cursor-pointer">
                            pontos insuficientes
                        </button>
                        <p class="pontos-faltantes-text text-red-500 text-sm mt-2"></p>
                    </div>
                </div>

                <div
                    class="CardProduto bg-white rounded-xl shadow-lg overflow-hidden transition duration-300 transform hover:scale-[1.02] border border-gray-100" data-produto-id="2" data-produto-preco="350">
                    <div class="h-40 bg-cover bg-center"
                        style="background-image: url('https://picsum.photos/400/200?random=2');">
                    </div>
                    <div class="p-5 text-center" data-produto-id="2" data-produto-preco="350">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Ecobag de Algodão Orgânico</h3>
                        <p class="text-gray-600 text-sm mb-4">Leve e resistente. Ideal para evitar sacolas plásticas.
                        </p>

                        <div class="text-2xl font-extrabold text-amber-500 mb-4">
                            <i class="fas fa-leaf text-emerald-700 mr-2"></i> 350 Pontos
                        </div>

                        <button
                            class="button-resgate w-full py-2 bg-emerald-700 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-800 transition duration-300 cursor-pointer">
                            Pontos insuficientes
                        </button>
                        <p class="pontos-faltantes-text text-red-500 text-sm mt-2"></p>
                    </div>
                </div>

                <div
                    class="CardProduto bg-white rounded-xl shadow-lg overflow-hidden pointer-events-none border border-gray-300">
                    <div class="h-40 bg-cover bg-center grayscale"
                        style="background-image: url('https://picsum.photos/400/200?random=3');">
                    </div>
                    <div class="p-5 text-center relative">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Mini-Curso de Compostagem</h3>
                        <p class="text-gray-500 text-sm mb-4">Aprenda a transformar seu lixo orgânico em adubo.</p>

                        <div class="text-2xl font-extrabold text-amber-500 mb-4">
                            <i class="fas fa-leaf text-amber-500 mr-2"></i> 600 Pontos
                        </div>

                        <button class="button-resgate w-full py-2 bg-emerald-700 text-white font-semibold rounded-lg cursor-not-allowed" id="buttonResgate">
                            Resgatar
                        </button>
                        <p class="pontos-faltantes-text text-red-500 text-sm mt-2"></p>
                    </div>
                </div>

                <div
                    class="CardProduto bg-white rounded-xl shadow-lg overflow-hidden transition duration-300 transform hover:scale-[1.02] border border-gray-100" data-produto-id="3" data-produto-preco="200">
                    <div class="h-40 bg-cover bg-center"
                        style="background-image: url('https://picsum.photos/400/200?random=4');">
                    </div>
                    <div class="p-5 text-center">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Doação para Projeto de Limpeza de Praias</h3>
                        <p class="text-gray-600 text-sm mb-4">Ajude a financiar a limpeza de 1m² de praia.</p>

                        <div class="text-2xl font-extrabold text-amber-500 mb-4">
                            <i class="fas fa-leaf text-emerald-700 mr-2"></i> 200 Pontos
                        </div>
                        <button
                            class="button-resgate w-full py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300  cursor-pointer">Doar</button>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <script src="carregaPontos.js"></script>
<script>
    // Função para atualizar os cards com base nos pontos
    function atualizarVisibilidadeCards() {
        // Pega os pontos do usuário (da nossa função global)
        const pontosDoUsuario = atualizarDisplayPontosGlobal();

        // Encontra todos os cards na tela
        const cards = document.querySelectorAll('.CardProduto');

        cards.forEach(card => {
            // Pega os dados que colocamos no HTML
            const produtoId = card.dataset.produtoId;
            const preco = parseInt(card.dataset.produtoPreco);
            const nomeProduto = card.querySelector('h3').innerText;

            // Encontra os elementos do card
            const botao = card.querySelector('.button-resgate');
            const textoFaltante = card.querySelector('.pontos-faltantes-text');

            if (pontosDoUsuario >= preco) {
                // Usuário PODE resgatar
                botao.disabled = false;
                botao.innerText = 'Resgatar'; // Ou "Doar" se for o caso
                botao.className = "button-resgate w-full py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 cursor-pointer";
                textoFaltante.innerText = '';

                // Adiciona a função de clique para chamar a API
                botao.onclick = () => resgatarProduto(produtoId, nomeProduto, preco);

            } else {
                // Usuário NÃO PODE resgatar
                botao.disabled = true;
                botao.innerText = 'Pontos Insuficientes';
                botao.className = "button-resgate w-full py-2 bg-gray-500 text-white font-semibold rounded-lg cursor-not-allowed";
                
                const faltam = preco - pontosDoUsuario;
                textoFaltante.innerText = `Faltam ${faltam} pontos`;
            }
        });
    }

    // Função que chama a API de resgate
    async function resgatarProduto(produtoId, nomeProduto, preco) {
        if (!confirm(`Você tem certeza que quer resgatar "${nomeProduto}" por ${preco} pontos?`)) {
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) return alert('Você não está logado.');

        try {
            // Chama a API que corrigimos no Passo 1
            const resposta = await fetch('http://localhost:3001/api/produtos/resgatar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ produtoId: produtoId })
            });

            const resultado = await resposta.json();

            if (!resposta.ok) {
                // Mostra o erro do back-end (ex: "Pontos insuficientes")
                throw new Error(resultado.mensagem);
            }

            // SUCESSO!
            alert(resultado.mensagem); // "Produto resgatado com sucesso!"

            // 1. Atualiza os pontos no localStorage
            localStorage.setItem('pontosUsuario', resultado.novoSaldoPontos);

            // 2. Atualiza o display dos pontos
            atualizarVisibilidadeCards();

        } catch (erro) {
            console.error('Erro ao resgatar:', erro);
            alert(`Falha no resgate: ${erro.message}`);
        }
    }
    document.addEventListener('DOMContentLoaded', atualizarVisibilidadeCards);
</script>
</body>
</html>